
# 关系型数据库设计规范

## 数据库架构
- 对业务连续性有严格要求的系统的数据库采用多集群的架构，多个集群的联机数据库之间相互独立无直接关联，多个集群的数据库中的对象（业务表、索引、约束等）结构一致，任意数据库集群均可对外提供服务，保证业务系统可以在数据库集群之间随时切换而不影响业务连续性，便于数据库的停机维护操作。
- 多个集群除了有各自的联机数据库，还有多个集群共用的一个后线库，多个集群的联机数据库中的数据通过数据同步工具准实时同步至后线库中。
- 数据库应有对应的从库和主库保持数据同步，用于灾难发生时数据库的主从切换从而快速恢复数据库可用性。
- 主从数据库通过keepalived的VIP对外提供服务，避免主从切换时产生的服务中断。
- 联机交易数据库有对应的跟主库同步的只读库，用于跟联机交易无关的查询操作，减轻联机交易库的负载。
- 为避免数据库体量增大可能导致的潜在性能问题，数据库上线之前合理估算跟业务相关的大表数据量，由此设计表的索引、分区等。

## 表
- 联机交易表采用两个或以上的套表，每隔一段时间（一天、一周或一月等）切换到另一个套表，便于对联机交易表的维护。例如每周7天的交易数据分别写入到表order_1, order_2 ... order_7，将order_n表的数据同步至后线库后在覆盖写入前truncate表order_n。
- 后线库中用于保存从联机库同步过来的数据的表设计为分区表，每天一个分区，清理数据采用drop分区的方法避免产生碎片。
- 随着时间推移越早的历史数据被访问的可能性越低，联机交易表的历史数据应及时迁移至后线库并清理。如果某个时间点以前的历史数据被访问的比例不超过1%，应将该时间点以前的历史数据迁移到大数据平台，涉及到该1%部分历史数据的访问从大数据平台获取。
- 每个表都应有非业务主键，作为该表每一行记录的唯一标识，同时应有创建时间、更新时间字段，便于数据转移、抽取、同步等操作。
- 出于对表性能影响对考虑，联机交易表不创建外键约束，在应用层面实现数据一致性的控制。
- 不会出现空值的列添加NOT NULL约束，这将直接影响优化器对SQL执行计划的选择，比如索引全扫描的前提条件是目标索引的键值列至少有一个是NOT NULL。

## 索引
- 联机交易表原则上不要超过6个索引，索引有且仅有一个好处就是加快查询，过多的索引会降低DML语句执行效率。
- 分区表的索引尽可能使用分区索引，某些场景下可以提高查询效率且便于对索引的维护。分区表上的全局索引在表的分区被drop后会产生碎片，定时对分区表上的全局索引进行rebuild释放表空间。
- OLTP系统创建的索引类型是普通B-Tree索引，不应创建位图索引。
- SQL语句中出现在where条件中的列才需要考虑添加索引。
- 某一列或几列是否适合添加索引取决于where条件的筛选率，当where条件过滤后的结果集行数不超过该表总行数的30%时走索引的效率高于全表扫描。
- 创建多列复合索引时将可选择率低的列作为该索引的前导列，可选择率=该列distinct值数量/表总行数。
- 不会出现重复值的列在创建索引时应创建唯一索引，这将直接影响优化器对SQL执行计划的选择，唯一索引往往比非唯一索引效率更高。

## SQL
- 代码中的SQL语句尽量不要添加hint。hint阻止了优化器选择以后可能出现的更优SQL执行计划。
- 联机交易系统代码的SQL不应开启并行，数据库中的对象如表、索引等并行度设置为1（即不开启并行）。
- SQL尽量使用绑定变量，有利于SQL文本和执行计划重用，减少硬解析，降低数据库资源消耗。
- 不使用select *，而是列出所需的列名代替 *，即select col1, col2, ...coln ...。
- exists子句的执行效率比in子句高，尽量用[not] exists子句替代[not] in子句。
- 不同数据类型的运算效率有高低之分，数值型>日期型>字符型。例如不要将两个日期通过to_char函数转化为字符型之后比较，而是将两个日期直接比较。


## 其他
- 应用的数据库连接池大小应固定不变，即最大连接数与最小连接数设置相同数值，避免动态数据库连接池导致数据库连接风暴的产生。连接池的大小不低于1倍数据库CPU核心数，不高于10倍数据库CPU核心数。数据库工作负载越倾向于消耗cpu，则连接池大小应倾向于接近1倍数据库CPU核心数；数据库工作负载越倾向于消耗磁盘I/O，则连接池大小应倾向于接近10倍数据库CPU核心数。
- 会定期删除数据的两千万行以上的大表，在数据删除后应定时对表进行收缩（shrink），对表的索引进行重建（rebuild）或重整（coalesce），减少表或者索引的碎片，防止出现潜在的性能问题。
- 用delete的方法清理数据时应控制每次处理的数据量在10万行以内，避免消耗过多的数据库undo表空间或事务日志空间。
- 当不同磁盘性能有差异时，针对oracle数据库，将online redo log放在性能最好当磁盘，其次是archive redo log，最后是datafile。


| tps | 在线库数据量 | 后线库数据量 | 响应时间(ms) | RTO(min) | RPO(min) |
| ----------- | ----------- | ----------- | ----------- | ----------- | ----------- |
| <5 |  |  |  |  |  |
| 5-10 |  |  |  |  |  |
| 10-20 |  |  |  |  |  |
| 20-50 |  |  |  |  |  |
| 50-100 |  |  |  |  |  |
| 100-200 |  |  |  |  |  |
| >200 |  |  |  |  |  |
